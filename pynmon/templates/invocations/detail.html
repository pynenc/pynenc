{% extends "base.html" %} {% block content %}
<div class="pynmon-container">
  <div class="row">
    <div class="col-12">
      <div class="card pynmon-card">
        <div
          class="card-header pynmon-card-header d-flex justify-content-between align-items-center"
        >
          <span class="compact-header"
            >Invocation {{ invocation.invocation_id }}</span
          >
          <div>
            <a href="/invocations" class="pynmon-btn-nav me-2">
              Back to Invocations
            </a>
            <a
              href="/calls?call_id={{ call.call_id|urlencode }}"
              class="pynmon-btn-nav me-2"
            >
              View Call
            </a>
            <a href="/tasks/{{ task.task_id }}" class="pynmon-btn-nav">
              View Task
            </a>
          </div>
        </div>
        <div class="card-body pynmon-card-body">
          <div class="row pynmon-row-compact">
            <!-- First column - Basic information (expanded to 4/10) -->
            <div class="col-md-4">
              <!-- Basic invocation information -->
              <div class="card pynmon-card mb-3">
                <div class="card-header pynmon-card-header compact-header">
                  Basic Information
                </div>
                <div class="card-body pynmon-card-body">
                  <table class="table pynmon-table">
                    <tbody>
                      <tr>
                        <th>Invocation ID:</th>
                        <td>
                          <span class="pynmon-id"
                            >{{ invocation.invocation_id }}</span
                          >
                        </td>
                      </tr>
                      <tr>
                        <th>Status:</th>
                        <td>
                          <span
                            class="badge {% if invocation.status.name == 'SUCCESS' %}bg-success {% elif invocation.status.name == 'FAILED' %}bg-danger {% elif invocation.status.name == 'RUNNING' %}bg-primary {% elif invocation.status.name == 'PENDING' %}bg-warning {% elif invocation.status.name == 'PAUSED' %}bg-info {% elif invocation.status.name == 'RETRY' %}bg-secondary {% else %}bg-dark{% endif %}"
                          >
                            {{ invocation.status.name }}
                          </span>
                        </td>
                      </tr>
                      <tr>
                        <th>Retries:</th>
                        <td>{{ invocation.num_retries }}</td>
                      </tr>
                      <tr>
                        <th>Parent Invocation:</th>
                        <td>
                          {% if invocation.parent_invocation %}
                          <a
                            href="/invocations/{{ invocation.parent_invocation.invocation_id }}"
                            class="pynmon-link-primary"
                          >
                            {{ invocation.parent_invocation.invocation_id }}
                          </a>
                          {% else %}
                          <span class="text-muted">None</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <th>Created At:</th>
                        <td>{{ created_at }}</td>
                      </tr>
                      {% if completed_at %}
                      <tr>
                        <th>Completed At:</th>
                        <td>{{ completed_at }}</td>
                      </tr>
                      {% endif %} {% if duration %}
                      <tr>
                        <th>Duration:</th>
                        <td>{{ duration }}</td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Workflow Context -->
              <div class="card pynmon-card mb-3">
                <div class="card-header pynmon-card-header compact-header">
                  Workflow Context
                </div>
                <div class="card-body pynmon-card-body">
                  <table class="table pynmon-table">
                    <tbody>
                      <tr>
                        <th>Current Workflow:</th>
                        <td>
                          <a
                            href="{{ workflow_info.sub_invocations_url }}"
                            class="pynmon-link-primary"
                          >
                            {{ workflow_info.workflow_id }}
                          </a>
                        </td>
                      </tr>
                      <tr>
                        <th>Invocation Role:</th>
                        <td>
                          {% if workflow_info.is_main_workflow_task %}
                          <span class="badge bg-info">Workflow Starter</span>
                          {% else %}
                          <span class="badge bg-secondary">Sub-task</span>
                          {% endif %}
                        </td>
                      </tr>
                      <tr>
                        <th>Workflow Type:</th>
                        <td>
                          {% if invocation.parent_invocation %}
                          <span class="badge bg-warning">Sub-workflow</span>
                          {% else %}
                          <span class="badge bg-primary">Main Workflow</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% if invocation.parent_invocation %}
                      <tr>
                        <th>Parent Workflow:</th>
                        <td>
                          <a
                            href="/workflows/{{ invocation.parent_invocation.workflow.workflow_id }}"
                            class="pynmon-link-primary"
                          >
                            {{ invocation.parent_invocation.workflow.workflow_id
                            }}
                          </a>
                        </td>
                      </tr>
                      {% endif %} {% if workflow_info.is_main_workflow_task %}
                      <tr>
                        <th>Workflow Task:</th>
                        <td>
                          <a
                            href="{{ workflow_info.workflow_task_url }}"
                            class="pynmon-link-primary"
                          >
                            {{ workflow_info.workflow_task_id }}
                          </a>
                        </td>
                      </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>

            <!-- Second column - Task/Workflow information and Arguments/Results (4/10) -->
            <div class="col-md-6">
              <!-- Task & Call information -->
              <div class="card pynmon-card mb-3">
                <div class="card-header pynmon-card-header compact-header">
                  Task & Call Information
                </div>
                <div class="card-body pynmon-card-body">
                  <table class="table pynmon-table">
                    <tbody>
                      <tr>
                        <th>Call ID:</th>
                        <td class="call-id-cell">
                          <a
                            href="/calls/?call_id={{ call.call_id|urlencode }}"
                            class="call-id-link pynmon-link-primary"
                          >
                            {{ call.call_id }}
                          </a>
                        </td>
                      </tr>
                      <tr>
                        <th>Task ID:</th>
                        <td>
                          <a
                            href="/tasks/{{ task.task_id }}"
                            class="pynmon-link-primary"
                          >
                            {{ task.task_id }}
                          </a>
                        </td>
                      </tr>
                      <tr>
                        <th>Task Module:</th>
                        <td>{{ task_extra.module }}</td>
                      </tr>
                      <tr>
                        <th>Task Function:</th>
                        <td>{{ task_extra.func_qualname }}</td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>

              <!-- Arguments -->
              <div class="card pynmon-card mb-3">
                <div class="card-header pynmon-card-header compact-header">
                  Arguments
                </div>
                <div class="card-body pynmon-card-body">
                  {% if arguments %} {% with args=arguments,
                  id_prefix='invocation-args' %} {% include
                  "partials/formatted_arguments.html" %} {% endwith%} {% else %}
                  <p class="text-muted data-text">No arguments provided</p>
                  {% endif %}
                </div>
              </div>

              <!-- Result / exception -->
              <div class="card pynmon-card mb-3">
                <div class="card-header pynmon-card-header compact-header">
                  Result / Exception
                </div>
                <div class="card-body pynmon-card-body">
                  {% if result is not none %}
                  <h6 class="text-success">Result:</h6>
                  <div class="result-container">
                    <pre class="result-content"><code>{{ result }}</code></pre>
                  </div>
                  {% elif exception is not none %}
                  <h6 class="text-danger">Exception:</h6>
                  <div class="result-container">
                    <pre
                      class="result-content"
                    ><code>{{ exception }}</code></pre>
                  </div>
                  {% else %}
                  <p class="text-muted">No result or exception available.</p>
                  {% endif %}
                </div>
              </div>
            </div>

            <!-- Third column - Status timeline sidebar (1/5) -->
            <div class="col-md-2">
              <div class="card pynmon-card">
                <div class="card-header pynmon-card-header compact-header">
                  Status Timeline
                </div>
                <div class="card-body pynmon-card-body">
                  {% if history %}
                  <div class="timeline compact-timeline">
                    {% for entry in history %}
                    <div class="timeline-item compact-timeline-item">
                      <div
                        class="timeline-marker {% if entry.status == 'SUCCESS' %}bg-success{% elif entry.status == 'FAILED' %}bg-danger{% elif entry.status == 'RUNNING' %}bg-primary{% elif entry.status == 'PENDING' %}bg-warning{% elif entry.status == 'PAUSED' %}bg-info{% elif entry.status == 'RETRY' %}bg-secondary{% else %}bg-dark{% endif %}"
                      ></div>
                      <div class="timeline-content compact-timeline-content">
                        <div class="timeline-title compact-timeline-title">
                          <span
                            class="badge {% if entry.status == 'SUCCESS' %}bg-success{% elif entry.status == 'FAILED' %}bg-danger{% elif entry.status == 'RUNNING' %}bg-primary{% elif entry.status == 'PENDING' %}bg-warning{% elif entry.status == 'PAUSED' %}bg-info{% elif entry.status == 'RETRY' %}bg-secondary{% else %}bg-dark{% endif %}"
                          >
                            {{ entry.status }}
                          </span>
                        </div>
                        <div class="timeline-date metadata-text">
                          {{ entry.timestamp }}
                        </div>
                        {% if entry.execution_context %}
                        <div class="timeline-text data-text">
                          {{ entry.execution_context }}
                        </div>
                        {% endif %}
                      </div>
                    </div>
                    {% endfor %}
                  </div>
                  {% else %}
                  <p class="text-muted data-text">No history available.</p>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <style>
    /* Timeline styling - very compact version for narrow sidebar */
    .timeline {
      position: relative;
      padding-left: 20px;
      margin-bottom: 8px;
    }

    .timeline:before {
      content: "";
      position: absolute;
      left: 8px;
      top: 0;
      height: 100%;
      width: 2px;
      background: #e9ecef;
    }

    .timeline-item {
      position: relative;
      margin-bottom: 8px; /* Further reduced for narrow column */
    }

    .timeline-marker {
      position: absolute;
      left: -18px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      top: 2px;
    }

    .timeline-content {
      padding-bottom: 3px; /* Very compact */
    }

    .timeline-title {
      margin-top: 0;
      font-size: 12px; /* Smaller for narrow column */
    }

    .timeline-date {
      color: #6c757d;
      font-size: 10px; /* Very small for narrow column */
      margin-bottom: 0.1rem;
    }

    .timeline-text {
      font-size: 10px;
      color: #6c757d;
    }

    /* Call ID styling to prevent overflow */
    .call-id-cell {
      max-width: 0;
      width: 100%;
    }

    .call-id-link {
      display: block;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 100%;
      /* Override pynmon-link-primary padding for proper ellipsis */
      padding: 0.125rem 0.375rem;
      background: #f8f9fa;
      border-radius: 0.25rem;
    }

    .result-container {
      max-height: 300px;
      overflow-y: auto;
      border: 1px solid #e9ecef;
      border-radius: 4px;
      background-color: #f8f9fa;
    }

    .result-content {
      margin: 0;
      padding: 10px;
      white-space: pre-wrap;
      word-break: break-word;
      font-size: 0.875rem;
    }

    /* Add some spacing between card sections */
    .mb-3 {
      margin-bottom: 1rem !important;
    }

    /* Enhanced parent workflow information styling */
    .small {
      font-size: 0.875rem;
    }
  </style>
  {% endblock %}
</div>
