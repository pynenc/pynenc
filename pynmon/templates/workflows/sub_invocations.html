{% extends "base.html" %} {% block content %}
<div class="pynmon-container">
  <div class="row">
    <div class="col-12">
      <div class="card pynmon-card">
        <div
          class="card-header pynmon-card-header d-flex justify-content-between align-items-center"
        >
          <span class="compact-header">Workflow Sub-Invocations</span>
          <div>
            {% if workflow_run %}
            <a
              href="/workflows/{{ workflow_run.workflow_task_id }}"
              class="pynmon-btn-nav me-2"
            >
              ‚Üê Back to Workflow
            </a>
            {% endif %}
            <a href="/workflows" class="pynmon-btn-nav"> All Workflows </a>
          </div>
        </div>
        <div class="card-body pynmon-card-body">
          <!-- Workflow Context Info -->
          <div class="row pynmon-row-compact mb-3">
            <div class="col-12">
              <div class="card pynmon-card">
                <div class="card-header pynmon-card-header compact-header">
                  Workflow Information
                </div>
                <div class="card-body pynmon-card-body">
                  <table class="table pynmon-table">
                    <tbody>
                      <tr>
                        <th style="width: 20%">Workflow ID:</th>
                        <td>
                          <code class="clickable-code">{{ workflow_id }}</code>
                        </td>
                      </tr>
                      {% if workflow_run %}
                      <tr>
                        <th>Workflow Task ID:</th>
                        <td>
                          <a
                            href="/workflows/{{ workflow_run.workflow_task_id }}"
                            class="text-decoration-none"
                          >
                            {{ workflow_run.workflow_task_id }}
                          </a>
                        </td>
                      </tr>
                      <tr>
                        <th>Main Invocation:</th>
                        <td>
                          <a
                            href="/invocations/{{ workflow_run.workflow_invocation_id }}"
                            class="text-decoration-none"
                          >
                            <code class="clickable-code"
                              >{{ workflow_run.workflow_invocation_id }}</code
                            >
                          </a>
                        </td>
                      </tr>
                      {% if workflow_run.parent_workflow %}
                      <tr>
                        <th>Parent Workflow:</th>
                        <td>
                          <a
                            href="/workflows/{{ workflow_run.parent_workflow.workflow_id }}/invocations"
                            class="text-decoration-none"
                          >
                            <code class="clickable-code"
                              >{{ workflow_run.parent_workflow.workflow_id[:8]
                              }}...</code
                            >
                          </a>
                        </td>
                      </tr>
                      {% endif %} {% endif %}
                      <tr>
                        <th>Total Sub-Invocations:</th>
                        <td>
                          <span class="badge bg-primary"
                            >{{ total_count }}</span
                          >
                          <span class="metadata-text ms-2">
                            ({{ sub_invocations|length }} task invocations, {{
                            sub_workflows|length }} child workflows)
                          </span>
                        </td>
                      </tr>
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>

          <!-- Sub-Workflows Section -->
          {% if sub_workflows %}
          <div class="row pynmon-row-compact mb-3">
            <div class="col-12">
              <div class="card pynmon-card">
                <div class="card-header pynmon-card-header compact-header">
                  <span class="material-icons me-2">workspaces</span>
                  Child Workflows ({{ sub_workflows|length }})
                </div>
                <div class="card-body pynmon-card-body">
                  <div class="table-responsive">
                    <table class="table table-hover pynmon-table">
                      <thead>
                        <tr>
                          <th>Child Workflow ID</th>
                          <th>Task ID</th>
                          <th>Invocation ID</th>
                          <th>Status</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in sub_workflows %}
                        <tr>
                          <td>
                            <a
                              href="/workflows/{{ item.workflow_id }}/invocations"
                              class="text-decoration-none"
                            >
                              <code class="clickable-code text-primary"
                                >{{ item.workflow_id[:12] }}...</code
                              >
                            </a>
                          </td>
                          <td>
                            <a
                              href="/tasks/{{ item.invocation.task.task_id }}"
                              class="text-decoration-none"
                            >
                              {{ item.invocation.task.task_id }}
                            </a>
                          </td>
                          <td>
                            <a
                              href="/invocations/{{ item.invocation.invocation_id }}"
                              class="text-decoration-none"
                            >
                              <code class="clickable-code"
                                >{{ item.invocation.invocation_id[:12]
                                }}...</code
                              >
                            </a>
                          </td>
                          <td>
                            <span
                              class="badge {% if item.invocation.status.name == 'SUCCESS' %}bg-success{% elif item.invocation.status.name == 'FAILED' %}bg-danger{% elif item.invocation.status.name == 'RUNNING' %}bg-primary{% elif item.invocation.status.name == 'PENDING' %}bg-warning{% elif item.invocation.status.name == 'PAUSED' %}bg-info{% elif item.invocation.status.name == 'RETRY' %}bg-secondary{% else %}bg-dark{% endif %}"
                            >
                              {{ item.invocation.status.name }}
                            </span>
                          </td>
                          <td>
                            <a
                              href="/workflows/{{ item.workflow_id }}/invocations"
                              class="pynmon-btn-nav me-1"
                            >
                              View Child Invocations
                            </a>
                            <a
                              href="/invocations/{{ item.invocation.invocation_id }}"
                              class="pynmon-btn-nav"
                            >
                              View Details
                            </a>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- Task Invocations Section -->
          {% if sub_invocations %}
          <div class="row pynmon-row-compact">
            <div class="col-12">
              <div class="card pynmon-card">
                <div class="card-header pynmon-card-header compact-header">
                  <span class="material-icons me-2">task</span>
                  Task Invocations ({{ sub_invocations|length }})
                </div>
                <div class="card-body pynmon-card-body">
                  <div class="table-responsive">
                    <table class="table table-hover pynmon-table">
                      <thead>
                        <tr>
                          <th>Invocation ID</th>
                          <th>Task ID</th>
                          <th>Call ID</th>
                          <th>Status</th>
                          <th>Retries</th>
                          <th>Actions</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for item in sub_invocations %}
                        <tr>
                          <td>
                            <a
                              href="/invocations/{{ item.invocation.invocation_id }}"
                              class="text-decoration-none"
                            >
                              <code class="clickable-code text-primary"
                                >{{ item.invocation.invocation_id[:12]
                                }}...</code
                              >
                            </a>
                          </td>
                          <td>
                            <a
                              href="/tasks/{{ item.invocation.task.task_id }}"
                              class="text-decoration-none"
                            >
                              {{ item.invocation.task.task_id.split('.')[-1] }}
                            </a>
                          </td>
                          <td>
                            <a
                              href="/calls/?call_id={{ item.invocation.call.call_id|urlencode }}"
                              class="text-decoration-none"
                            >
                              <code class="text-secondary"
                                >{{
                                item.invocation.call.call_id.split('#')[-1][:12]
                                if '#' in item.invocation.call.call_id else
                                item.invocation.call.call_id[:12] }}...</code
                              >
                            </a>
                          </td>
                          <td>
                            <span
                              class="badge {% if item.invocation.status.name == 'SUCCESS' %}bg-success{% elif item.invocation.status.name == 'FAILED' %}bg-danger{% elif item.invocation.status.name == 'RUNNING' %}bg-primary{% elif item.invocation.status.name == 'PENDING' %}bg-warning{% elif item.invocation.status.name == 'PAUSED' %}bg-info{% elif item.invocation.status.name == 'RETRY' %}bg-secondary{% elif item.invocation.status.name == 'REGISTERED' %}bg-secondary{% elif item.invocation.status.name == 'REROUTED' %}bg-info{% elif item.invocation.status.name == 'SCHEDULED' %}bg-warning text-dark{% else %}bg-dark{% endif %}"
                            >
                              {{ item.invocation.status.name }}
                            </span>
                          </td>
                          <td>{{ item.invocation.num_retries }}</td>
                          <td>
                            <a
                              href="/invocations/{{ item.invocation.invocation_id }}"
                              class="pynmon-btn-nav me-1"
                            >
                              View Details
                            </a>
                            <a
                              href="/calls/?call_id={{ item.invocation.call.call_id|urlencode }}"
                              class="pynmon-btn-nav"
                            >
                              View Call
                            </a>
                          </td>
                        </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                </div>
              </div>
            </div>
          </div>
          {% endif %}

          <!-- No Data State -->
          {% if not sub_invocations and not sub_workflows %}
          <div class="alert alert-info">
            <h6>No invocations found</h6>
            <p class="mb-0">
              This workflow has no task invocations or child workflows running
              within it yet. Task invocations and child workflows will appear
              here when tasks are executed within this workflow context.
            </p>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
