{% extends "base.html" %} {% block content %}
<div class="pynmon-container">
  <div class="col-12">
    <div class="card pynmon-card">
      <div
        class="card-header d-flex justify-content-between align-items-center compact-header"
      >
        <span>Task Details</span>
        <a href="/tasks" class="pynmon-btn-nav"> Back to Tasks </a>
      </div>
      <div class="card-body">
        <div class="row pynmon-row-compact">
          <div class="col-md-6">
            <div class="card pynmon-card">
              <div class="card-header compact-header">Basic information</div>
              <div class="card-body">
                <table class="table pynmon-table">
                  <tbody>
                    <tr>
                      <th>Task ID:</th>
                      <td><strong>{{ task.task_id }}</strong></td>
                    </tr>
                    <tr>
                      <th>Module:</th>
                      <td>{{ task_extra.module }}</td>
                    </tr>
                    <tr>
                      <th>Function:</th>
                      <td>{{ task_extra.func_qualname }}</td>
                    </tr>
                    {% if workflow_info %}
                    <tr>
                      <th>Workflow Task:</th>
                      <td>
                        <span class="badge bg-primary">Yes</span>
                        {% if workflow_info.force_new_workflow %}
                        <span class="badge bg-info">Force New Workflow</span>
                        {% endif %}
                      </td>
                    </tr>
                    <tr>
                      <th>Workflow Runs:</th>
                      <td>
                        <a
                          href="{{ workflow_info.workflow_task_url }}"
                          class="text-decoration-none"
                        >
                          {{ workflow_info.total_workflow_runs }} run(s)
                        </a>
                      </td>
                    </tr>
                    {% endif %}
                  </tbody>
                </table>
              </div>
            </div>
          </div>

          <div class="col-md-6">
            <div class="card pynmon-card">
              <div
                class="card-header compact-header d-flex justify-content-between align-items-center"
              >
                Configuration {% if config_info.differences %}
                <small class="text-muted"
                  >({{ config_info.differences|length }} modified)</small
                >
                {% else %}
                <small class="text-muted">(all defaults)</small>
                {% endif %}
              </div>
              <div class="card-body">
                {% if config_info.differences %}
                <table class="table pynmon-table">
                  <tbody>
                    {% for key, value in config_info.differences.items() %}
                    <tr>
                      <th>{{ key|replace('_', ' ')|title }}:</th>
                      <td>
                        {% if key in ['registration_concurrency',
                        'running_concurrency'] %} {{ value.name }} {% elif key
                        in ['key_arguments', 'disable_cache_args'] %} {{
                        value|join(', ') or 'None' }} {% elif key == 'retry_for'
                        %} {{ task_extra.retry_for|join(', ') }} {% else %} {{
                        value }} {% endif %}
                        <span class="badge bg-warning">Modified</span>
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>

                <button
                  class="btn btn-sm btn-outline-secondary"
                  data-bs-toggle="collapse"
                  data-bs-target="#all-config"
                >
                  Show All Configuration
                </button>

                <div class="collapse mt-3" id="all-config">
                  <table class="table pynmon-table table-sm">
                    <tbody>
                      {% for key, current_value in
                      config_info.all_current.items() %}
                      <tr>
                        <th>{{ key|replace('_', ' ')|title }}:</th>
                        <td>
                          {% if key in ['registration_concurrency',
                          'running_concurrency'] %} {{ current_value.name if
                          current_value else 'None' }} {% elif key in
                          ['key_arguments', 'disable_cache_args'] %} {{
                          current_value|join(', ') if current_value else 'None'
                          }} {% elif key == 'retry_for' %} {{
                          task_extra.retry_for|join(', ') }} {% else %} {{
                          current_value }} {% endif %} {% if key in
                          config_info.differences %}
                          <span class="badge bg-warning">Modified</span>
                          {% else %}
                          <span class="badge bg-secondary">Default</span>
                          {% endif %}
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">
                  All configuration values are using defaults.
                </p>

                <button
                  class="pynmon-toggle-btn"
                  data-bs-toggle="collapse"
                  data-bs-target="#default-config"
                >
                  Show Default Configuration
                </button>

                <div class="collapse mt-3" id="default-config">
                  <table class="table pynmon-table table-sm">
                    <tbody>
                      {% for key, value in config_info.all_current.items() %}
                      <tr>
                        <th>{{ key|replace('_', ' ')|title }}:</th>
                        <td>
                          {% if key in ['registration_concurrency',
                          'running_concurrency'] %} {{ value.name if value else
                          'None' }} {% elif key in ['key_arguments',
                          'disable_cache_args'] %} {{ value|join(', ') if value
                          else 'None' }} {% elif key == 'retry_for' %} {{
                          task_extra.retry_for|join(', ') }} {% else %} {{ value
                          }} {% endif %}
                          <span class="badge bg-secondary">Default</span>
                        </td>
                      </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% endif %}
              </div>
            </div>
          </div>
        </div>

        <div class="row pynmon-row-compact">
          <div class="col-12">
            <div class="card pynmon-card">
              <div class="card-header compact-header">
                Active Calls ({{ calls|length }})
              </div>
              <div class="card-body">
                {% if calls %}
                <div class="table-responsive">
                  <table class="table table-hover pynmon-table">
                    <thead>
                      <tr>
                        <th>Call ID</th>
                        <th>Arguments</th>
                        <th>Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for call in calls %}
                      <tr>
                        <td>
                          {% if call and call.call_id %}
                          <a
                            href="/calls/?call_id={{ call.call_id|urlencode }}"
                            title="{{ call.call_id }}"
                          >
                            {{ call.call_id }}
                          </a>
                          {% else %}
                          <span class="text-muted">Invalid ID</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if call and call.serialized_arguments %}
                          <button
                            class="pynmon-toggle-btn"
                            data-bs-toggle="collapse"
                            data-bs-target="#args-{{ loop.index }}"
                          >
                            View
                          </button>
                          {% else %}
                          <span class="text-muted">No arguments</span>
                          {% endif %}
                        </td>
                        <td>
                          {% if call and call.call_id %}
                          <a
                            href="/calls?call_id={{ call.call_id|urlencode }}"
                            class="pynmon-btn-nav"
                            >Details</a
                          >
                          {% else %}
                          <span class="pynmon-btn-nav" style="opacity: 0.5">
                            Details
                          </span>
                          {% endif %}
                        </td>
                      </tr>
                      {% if call and call.serialized_arguments %}
                      <tr class="collapse" id="args-{{ loop.index }}">
                        <td colspan="3">
                          {% with args=call.serialized_arguments,
                          id_prefix='task-call-'~loop.index %} {% include
                          "partials/formatted_arguments.html" %} {% endwith %}
                        </td>
                      </tr>
                      {% endif %} {% endfor %}
                    </tbody>
                  </table>
                </div>
                {% else %}
                <p class="text-muted">No active calls for this task.</p>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}
